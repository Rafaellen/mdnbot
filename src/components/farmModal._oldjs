const { ActionRowBuilder, StringSelectMenuBuilder, EmbedBuilder, ButtonBuilder, ButtonStyle } = require('discord.js');
const supabase = require('../database/supabase');

// Armazenamento tempor√°rio para farms em processo
const farmsEmProcesso = new Map();

async function processarFarm(interaction, farmId, acao) {
    try {
        if (acao === 'selecionar') {
            // Usu√°rio selecionou o tipo de farm
            const tipoFarm = interaction.values[0];
            
            // Criar ID tempor√°rio √∫nico
            const tempId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            // Salvar temporariamente
            farmsEmProcesso.set(tempId, {
                tipo: tipoFarm,
                usuario: interaction.user.id,
                canal: interaction.channel.id,
                timestamp: Date.now()
            });
            
            // Obter informa√ß√µes do membro
            const { data: membro } = await supabase
                .from('membros')
                .select('id, nome')
                .eq('discord_id', interaction.user.id)
                .single();
            
            if (!membro) {
                return interaction.reply({
                    content: '‚ùå Voc√™ precisa estar registrado para farmar!',
                    flags: 64
                });
            }
            
            // Criar embed
            const embed = new EmbedBuilder()
                .setTitle('üìä REGISTRO DE FARM')
                .setDescription(`**${membro.nome}** selecionou: **${tipoFarm}**`)
                .setColor(0xFFA500)
                .addFields(
                    { name: 'üìù Instru√ß√µes:', value: 'Clique no bot√£o abaixo para informar a quantidade farmada.' },
                    { name: 'üÜî ID Tempor√°rio:', value: tempId },
                    { name: '‚è∞ V√°lido por:', value: '5 minutos' }
                )
                .setFooter({ text: `Usu√°rio: ${interaction.user.username}` })
                .setTimestamp();

            const botoes = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId(`editar_farm_${tempId}`)
                        .setLabel('INFORMAR QUANTIDADE')
                        .setStyle(ButtonStyle.Primary)
                        .setEmoji('üí∞'),
                    new ButtonBuilder()
                        .setCustomId(`finalizar_farm_${tempId}`)
                        .setLabel('CANCELAR')
                        .setStyle(ButtonStyle.Danger)
                        .setEmoji('‚ùå')
                );

            await interaction.reply({
                embeds: [embed],
                components: [botoes]
            });

        } else if (acao === 'finalizar') {
            // Cancelar farm
            const tempId = farmId;
            farmsEmProcesso.delete(tempId);
            
            await interaction.update({
                content: '‚ùå Farm cancelado.',
                components: [],
                embeds: []
            });
        }
    } catch (error) {
        console.error('Erro no processamento de farm:', error);
        if (interaction.replied || interaction.deferred) {
            await interaction.editReply({
                content: '‚ùå Erro ao processar farm.',
                components: []
            });
        } else {
            await interaction.reply({
                content: '‚ùå Erro ao processar farm.',
                flags: 64
            });
        }
    }
}

// Fun√ß√£o auxiliar para salvar farm no banco (chamada do modal)
async function salvarFarmNoBanco(tempId, quantidade, interaction) {
    try {
        const farmTemp = farmsEmProcesso.get(tempId);
        if (!farmTemp) {
            throw new Error('Farm expirado ou n√£o encontrado');
        }
        
        // Verificar se √© o mesmo usu√°rio
        if (farmTemp.usuario !== interaction.user.id) {
            throw new Error('Voc√™ n√£o pode editar este farm');
        }
        
        // Verificar se expirou (5 minutos)
        if (Date.now() - farmTemp.timestamp > 5 * 60 * 1000) {
            farmsEmProcesso.delete(tempId);
            throw new Error('Farm expirado. Por favor, inicie um novo registro.');
        }
        
        // Obter semana atual
        const data = new Date();
        const semanaNumero = getWeekNumber(data);
        const ano = data.getFullYear();
        
        // Buscar membro
        const { data: membro } = await supabase
            .from('membros')
            .select('id, nome')
            .eq('discord_id', interaction.user.id)
            .single();
        
        if (!membro) {
            throw new Error('Membro n√£o encontrado');
        }
        
        // Inserir no banco
        const { data: farmSalvo, error: insertError } = await supabase
            .from('farm_semanal')
            .insert([
                {
                    membro_id: membro.id,
                    tipo_farm: farmTemp.tipo,
                    quantidade: quantidade,
                    semana_id: semanaNumero,
                    ano: ano,
                    data_farm: new Date().toISOString()
                }
            ])
            .select()
            .single();
        
        if (insertError) {
            console.error('Erro ao inserir farm:', insertError);
            throw insertError;
        }
        
        // Limpar do armazenamento tempor√°rio
        farmsEmProcesso.delete(tempId);
        
        return {
            sucesso: true,
            farmId: farmSalvo.id,
            tipo: farmTemp.tipo,
            quantidade: quantidade,
            membroNome: membro.nome
        };
        
    } catch (error) {
        console.error('Erro ao salvar farm no banco:', error);
        throw error;
    }
}

// Fun√ß√£o para obter n√∫mero da semana
function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return weekNo;
}

module.exports = {
    processarFarm,
    salvarFarmNoBanco,
    farmsEmProcesso
};